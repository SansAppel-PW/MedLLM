# V100-32GB x2 runtime template (AutoDL)
# Usage:
#   set -a
#   source configs/runtime/v100_dual_32g.env
#   set +a
#   bash scripts/migration/run_day1_v100_dual.sh

# -------- GPU/runtime baseline --------
export CUDA_VISIBLE_DEVICES="${CUDA_VISIBLE_DEVICES:-0,1}"
export TOKENIZERS_PARALLELISM="${TOKENIZERS_PARALLELISM:-false}"
export OMP_NUM_THREADS="${OMP_NUM_THREADS:-8}"
export PYTORCH_CUDA_ALLOC_CONF="${PYTORCH_CUDA_ALLOC_CONF:-max_split_size_mb:128}"

# Optional: move HF cache to data disk.
export HF_HOME="${HF_HOME:-/root/autodl-tmp/hf}"
export HUGGINGFACE_HUB_CACHE="${HUGGINGFACE_HUB_CACHE:-/root/autodl-tmp/hf/hub}"
export TRANSFORMERS_CACHE="${TRANSFORMERS_CACHE:-/root/autodl-tmp/hf/transformers}"

# -------- Day1 entry --------
export BRANCH="${BRANCH:-codex/worktree}"
export MODEL_NAME="${MODEL_NAME:-Qwen/Qwen2.5-7B-Instruct}"
export MODEL_TIER="${MODEL_TIER:-7b}"
export ALIGNMENT_MODE="${ALIGNMENT_MODE:-real}"
export ALLOW_SKIP_TRAINING="${ALLOW_SKIP_TRAINING:-false}"
export FORCE_SKIP_TRAINING="${FORCE_SKIP_TRAINING:-false}"
export DAY1_DRY_RUN="${DAY1_DRY_RUN:-false}"

# API evaluation switches (adjust by budget).
export ENABLE_LLM_JUDGE="${ENABLE_LLM_JUDGE:-false}"
export ENABLE_LLM_RISK_JUDGE="${ENABLE_LLM_RISK_JUDGE:-true}"
export ENABLE_V2_LLM_FALLBACK="${ENABLE_V2_LLM_FALLBACK:-true}"

# -------- Layer-B real SFT --------
export MAX_LENGTH="${MAX_LENGTH:-1536}"
export NUM_EPOCHS="${NUM_EPOCHS:-1}"
export MAX_STEPS="${MAX_STEPS:--1}"
export TRAIN_BSZ="${TRAIN_BSZ:-1}"
export EVAL_BSZ="${EVAL_BSZ:-1}"
export GRAD_ACC="${GRAD_ACC:-24}"
export GRAD_CKPT="${GRAD_CKPT:-true}"
export NUM_WORKERS="${NUM_WORKERS:-2}"
export SAVE_TOTAL_LIMIT="${SAVE_TOTAL_LIMIT:-2}"
export LOAD_IN_4BIT="${LOAD_IN_4BIT:-true}"
export BF16="${BF16:-false}"
export FP16="${FP16:-true}"

# -------- DPO / SimPO / KTO --------
export ALIGN_MAX_LENGTH="${ALIGN_MAX_LENGTH:-1024}"
export ALIGN_MAX_STEPS="${ALIGN_MAX_STEPS:-240}"
export ALIGN_TRAIN_BSZ="${ALIGN_TRAIN_BSZ:-1}"
export ALIGN_GRAD_ACC="${ALIGN_GRAD_ACC:-32}"
export ALIGN_GRAD_CKPT="${ALIGN_GRAD_CKPT:-true}"
export ALIGN_SAVE_TOTAL_LIMIT="${ALIGN_SAVE_TOTAL_LIMIT:-2}"
export ALIGN_LOAD_IN_4BIT="${ALIGN_LOAD_IN_4BIT:-true}"
export ALIGN_BF16="${ALIGN_BF16:-false}"
export ALIGN_FP16="${ALIGN_FP16:-true}"

# -------- Resource gates --------
# 2xV100-32GB total ~= 64GB.
export MIN_CUDA_MEM_GB_7B="${MIN_CUDA_MEM_GB_7B:-30}"
export MIN_CUDA_MEM_GB_14B="${MIN_CUDA_MEM_GB_14B:-72}"

# -------- Eval profile --------
export DET_MAX="${DET_MAX:-0}"
export EVAL_MAX="${EVAL_MAX:-1200}"
export SOTA_MAX="${SOTA_MAX:-1800}"
export LOG_EVERY="${LOG_EVERY:-300}"
